<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Protocole Valentin v0.1üíò</title>

  <style>
  :root { font-family: "Comic Sans MS", "Comic Sans", system-ui, Arial; }

  body{
    margin:0;
    /* ugly tiled background */
    background:
      repeating-linear-gradient(45deg,
        #ff00ff 0 14px,
        #00ffff 14px 28px,
        #ffff00 28px 42px,
        #00ff00 42px 56px);
    background-attachment: fixed;
  }

  /* Fake marquee rainbow border frame */
  .wrap{
    max-width: 820px;
    margin: 0 auto;
    padding: 18px;
    border: 8px ridge #ff0;
    outline: 6px ridge #0ff;
    background: rgba(0,0,0,0.55);
    box-shadow: 0 0 0 6px #f0f, 0 0 0 12px #0f0, 0 0 0 18px #00f;
  }

  .card{
    position: relative;
    min-height: 380px;
    padding: 18px;
    overflow: hidden;

    /* truly questionable background */
    background:
      radial-gradient(circle at 10% 20%, rgba(255,255,255,0.25), transparent 40%),
      radial-gradient(circle at 90% 30%, rgba(0,255,255,0.25), transparent 45%),
      linear-gradient(180deg, rgba(255,0,255,0.25), rgba(0,255,0,0.15));
    border: 6px groove #ff5fa2;
    outline: 4px dotted #00ffff;
    box-shadow: 0 0 25px rgba(0,0,0,0.6);
    color: #fff;
  }

  /* Rainbow animated text (applied via class .rainbow) */
  .rainbow{
    font-weight: 900;
    text-shadow: 2px 2px 0 #000, 0 0 10px rgba(255,255,255,0.25);
    animation: hue 1.1s linear infinite, wobble 0.8s ease-in-out infinite alternate;
  }
  @keyframes hue { to { filter: hue-rotate(360deg); } }
  @keyframes wobble { from { transform: rotate(-1deg) } to { transform: rotate(1deg) } }

  h1{
    margin: 0 0 10px;
    font-size: 34px;
    letter-spacing: 1px;
  }

  p{
    line-height: 1.5;
    font-size: 16px;
  }

  .row{
    display:flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 14px;
  }

  button{
    border: 4px outset #fff;
    border-radius: 0; /* very 90s */
    padding: 10px 14px;
    font-weight: 900;
    cursor: pointer;
    text-transform: uppercase;
    box-shadow: 3px 3px 0 #000;
    background: #c0c0c0;
    color: #000;
  }
  button:active{
    border-style: inset;
    transform: translate(2px,2px);
    box-shadow: 1px 1px 0 #000;
  }

  .yes{
    background: linear-gradient(90deg, #ff0, #f0f, #0ff, #0f0, #ff0);
    animation: hue 0.9s linear infinite;
    color: #000;
  }

  .no{
    background: #000;
    color: #fff;
    position: absolute;
    left: 50px;
    top: 240px;
    border-color: #f0f #0ff #0f0 #ff0;
    animation: hue 1.2s linear infinite;
  }

  input{
    width: min(420px, 100%);
    padding: 10px 12px;
    border-radius: 0;
    border: 4px inset #fff;
    background: #000;
    color: #0f0;
    font-size: 16px;
    box-shadow: 2px 2px 0 #000;
  }

  .small{
    font-size: 12px;
    color: #ff0;
    text-shadow: 1px 1px 0 #000;
    margin-top: 10px;
  }

  .img {
  width: 100%;
  height: 260px;
  object-fit: contain;
  background: repeating-linear-gradient(
    45deg,
    #000 0 10px,
    #111 10px 20px
  );
  margin: 12px 0;
  border: 6px groove #0ff;
  outline: 3px dashed #ff0;
  }


  .badge{
    display: inline-block;
    padding: 6px 10px;
    border-radius: 0;
    background: #000;
    border: 3px double #ff0;
    color: #ff0;
    font-size: 12px;
    box-shadow: 2px 2px 0 #000;
  }

  /* Optional: a fake marquee strip */
  .marquee{
    margin: 10px 0 14px;
    padding: 6px 10px;
    border: 4px ridge #ff0;
    background: rgba(0,0,0,0.75);
    color: #fff;
    font-weight: 900;
    white-space: nowrap;
    overflow: hidden;
    position: relative;
  }
  .marquee span{
    display:inline-block;
    padding-left: 100%;
    animation: scroll 10s linear infinite;
  }
  @keyframes scroll { from { transform: translateX(0);} to { transform: translateX(-100%);} }
</style>
</head>

<body>
<div class="wrap">
  <div class="card" id="card"></div>
</div>

<script>
/* ================= CONFIG ================= */

const PEOPLE = {
  ignacio: {
    name: "Ignacio",
    jokes: ["Ti√© le best", "Wow tellement bo"],
    images: ["https://placekitten.com/800/400"]
  },
  axel: {
    name: "Axel",
    jokes: [
      "Ti√© ma lumi√®re bor√©ale du p√¥le emploi",
      "Allo bingading naani moderately stylish Igbo"
    ],
    images: ["images/axel1.jpg", "images/axel2.jpg"]
  },
  matias: {
    name: "Matias",
    jokes: [
      "Bebou tu es le Xavi √† mon Messi",
      "DINGDONG el √∫nico chileno m√°s o menos como la gente"
    ],
    images: ["images/mati1.png", "images/mati2.png"]
  },
  jp: {
    name: "JP",
    jokes: [
      "Je peux te sentir d'ici mais j'aime √ßo comm√™me",
      "N'oublie pas de te laver le crack petit cochonou"
    ],
    images: ["images/jp1.jpg", "images/jp2.jpg"]
  },
  clarisse: {
    name: "Clarisse",
    jokes: [
      "Ti√© le picchu √† mon machu",
      "La plus belle des pattes d'oie (pattes d'oie count)"
    ],
    images: ["images/cla1.jpg", "images/cla2.jpg"]
  }
};

const CODES = {
  ignacio: "enlegende",
  axel: "HEYDJEEZAS",
  matias: "gawkgawklacoree",
  jp: "GleQpourri",
  clarisse: "soglam4ever",
};


/* ================= STATE ================= */

const qs = new URLSearchParams(location.search);
const party = (qs.get("party") || "VAL2026").trim(); // change default if you want
const meId = (qs.get("who") || "").toLowerCase();
const me = PEOPLE[meId] ? meId : null;

const card = document.getElementById("card");
const state = {
  typedName: "",
  noCount: 0,
  assignment: null,
  jokeIndex: null
};

/* ================= HELPERS ================= */

const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const pick = arr => arr[rand(0,arr.length-1)];

const STORAGE_KEY = `valentin_cycle_v1_${party}`;

function isAdmin(){
  return me === "ignacio";
}

function getOrCreateAssignment(){
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      // basic sanity check: must have all people keys
      const ids = Object.keys(PEOPLE);
      const ok = ids.every(id => parsed[id]) && ids.every(id => parsed[id] !== id);
      if (ok) return parsed;
    } catch {}
  }
  const fresh = generateCycleAssignment();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(fresh));
  return fresh;
}

function resetAssignment(){
  localStorage.removeItem(STORAGE_KEY);
  state.assignment = getOrCreateAssignment();
}

function shuffle(arr){
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function render(html){ card.innerHTML = html; }

// Simple deterministic PRNG from a string seed (party)
function hashStringToUint32(str){
  let h = 2166136261; // FNV-1a base
  for (let i = 0; i < str.length; i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}

// Mulberry32 PRNG
function mulberry32(seed){
  return function(){
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function seededShuffle(arr, seedStr){
  const a = arr.slice();
  const rng = mulberry32(hashStringToUint32(seedStr));
  for (let i = a.length - 1; i > 0; i--){
    const j = Math.floor(rng() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}


/* ================= ASSIGNMENT ================= */

function generateCycleAssignment(){
  const ids = seededShuffle(Object.keys(PEOPLE), party);
  const map = {};
  ids.forEach((id, i) => {
    map[id] = ids[(i + 1) % ids.length];
  });
  return map;
}

state.assignment = getOrCreateAssignment();

/* ================= SCREENS ================= */
(function addSparkles(){
  const colors = ["#ff0", "#f0f", "#0ff", "#0f0", "#fff", "#f00", "#00f"];
  document.addEventListener("mousemove", (e) => {
    if (Math.random() > 0.25) return;
    const s = document.createElement("div");
    s.textContent = pick(["‚ú¶","‚úß","‚òÖ","‚òÜ","‚ú∫"]);
    s.style.position = "fixed";
    s.style.left = (e.clientX + rand(-10, 10)) + "px";
    s.style.top  = (e.clientY + rand(-10, 10)) + "px";
    s.style.pointerEvents = "none";
    s.style.fontWeight = "900";
    s.style.color = colors[rand(0, colors.length - 1)];
    s.style.textShadow = "1px 1px 0 #000";
    s.style.zIndex = 9999;
    s.style.transition = "transform 700ms linear, opacity 700ms linear";
    document.body.appendChild(s);
    requestAnimationFrame(() => {
      s.style.transform = `translate(${rand(-20,20)}px, ${rand(-40,-10)}px) scale(${0.6 + Math.random()*1.4})`;
      s.style.opacity = "0";
    });
    setTimeout(() => s.remove(), 750);
  });
})();

function screenCheater(reason){
  render(`
    <h1 class="rainbow">üö® ALERTE TRICHE üö®</h1>
    <p><b>NON.</b> Tu as essay√© de gruger. C‚Äôest tr√®s vilain.</p>
    <p>${reason || "Tu as essay√© de gruger. C‚Äôest tr√®s vilain."}</p>
    <p class="small">Je m'attendais pas √† grand chose de ta part mais √ßa...</p>
    <div class="row">
      <button class="yes" id="back">OK j‚Äôavoue, je reviens</button>
    </div>
  `);

  document.getElementById("back").onclick = screen2;
}


function screen1(){
  render(`
    <div class="badge">Protocole Valentin v0.1üíò</div>
    <h1>ALLO ALLO BINGADING</h1>
    <p>Veux-tu √™tre <b>le¬∑la Valentin¬∑e de nous tous</b> ?</p>

    <div class="row">
      <button class="yes" id="yes">OUI ü•∞</button>
      <button class="no" id="no">non</button>
    </div>

    <p class="small">bodji kount si tu refuses</p>
  `);

  document.getElementById("yes").onclick = screen2;

  const no = document.getElementById("no");
  const dodge = () => {
    state.noCount++;
    no.style.left = rand(10, card.clientWidth - 120) + "px";
    no.style.top = rand(160, card.clientHeight - 60) + "px";
    no.style.transform = `scale(${0.7 + Math.random()*1.1})`;
    if (state.noCount % 2 === 0) {
      no.textContent = pick(["non", "jamais", "mdr non", "√ßa va pas", "nan", "G peur de l'amour", "Je vous aime pas", "G des MST", "pas envie deso"]);
    }
  };
  no.onmouseenter = dodge;
  no.onclick = dodge;
}

function screen2(){
  // If someone opens without a valid ?who=..., block right away
  if (!me) {
    screenCheater("Ton lien ne contient pas un identifiant valide. Mets ton vrai pr√©nom. <b>");
    return;
  }

  render(`
    <h1 class="rainbow">Identification üîç</h1>
    <p>Entre ton pr√©nom <b>ET</b> le code secret qu‚ÄôIgnacio t‚Äôa donn√© :</p>

    <input id="name" placeholder="Ton pr√©nom" />
    <div style="height:10px"></div>
    <input id="code" placeholder="Code secret" />

    <div class="row">
      <button class="yes" id="go">Continuer</button>
    </div>

    <p class="small">Conseil : si tu triches, Cupidon te met une grande patate dans les chicor√©es.</p>
  `);

  const nameInput = document.getElementById("name");
  const codeInput = document.getElementById("code");
  const goBtn = document.getElementById("go");

  nameInput.focus();

  const proceed = () => {
    const enteredName = nameInput.value.trim();
    const enteredCode = (codeInput.value || "").trim();

    const expected = (CODES[me] || "").trim();

    // Normalize codes (case-insensitive, ignore surrounding spaces)
    const ok = expected && enteredCode.toLowerCase() === expected.toLowerCase();

    if (!ok) {
      // Optional: add a little lockout counter if you want later
      screenCheater("Code incorrect bouffi√±os");
      return;
    }

    state.typedName = enteredName || PEOPLE[me].name;
    screenMini1();
  };

  goBtn.addEventListener("click", proceed);
  codeInput.addEventListener("keydown", (e) => { if (e.key === "Enter") proceed(); });
  nameInput.addEventListener("keydown", (e) => { if (e.key === "Enter") codeInput.focus(); });
}

function screenMini1(){
  const p = me ? PEOPLE[me] : null;

  let line = "Ton existence est d√©sormais romantiquement enregistr√©e.";
  if (p && Array.isArray(p.jokes) && p.jokes.length >= 2) {
    state.jokeIndex = Math.random() < 0.5 ? 0 : 1;
    line = p.jokes[state.jokeIndex];
  } else {
    state.jokeIndex = null;
  }

  render(`
    <h1>${state.typedName} üíû</h1>
    <p>${line}</p>
    ${p ? `<img class="img" src="${p.images[0]}" />` : ""}
    <div class="row">
      <button class="yes" id="next">Next</button>
    </div>
  `);

  document.getElementById("next").onclick = screenMini2;
}

function screenMini2(){
  const p = me ? PEOPLE[me] : null;

  let line = "Ton aura est‚Ä¶ confuse mais attachante.";
  if (p && Array.isArray(p.jokes) && p.jokes.length >= 2 && (state.jokeIndex === 0 || state.jokeIndex === 1)) {
    const otherIndex = 1 - state.jokeIndex;
    line = p.jokes[otherIndex];
  }
  render(`
    <h1>J'ai lu dans ton esprit üß†</h1>
    <p>${line}</p>
    ${p && p.images[1] ? `<img class="img" src="${p.images[1]}" />` : ""}
    <p>R√©sultat : raciste, mais plein(e) d'amour.</p>
    <div class="row">
      <button class="yes" id="reveal">R√©v√©ler mon¬∑ma Valentin¬∑e</button>
    </div>
  `);
  document.getElementById("reveal").onclick = screenFinal;
}

function screenFinal(){
  if (!me){
    render(`<h1>Erreur ‚ùå</h1><p>Ce lien ne sait pas qui tu es.</p>`);
    return;
  }

  const targetId = state.assignment[me];
  const target = PEOPLE[targetId].name;

  render(`
    <h1>üéÅ Mission secr√®te</h1>
    <p>${state.typedName}, tu es le¬∑la Valentin¬∑e officiel¬∑le de :</p>
    <p style="font-size:42px"><b>${target}</b></p>
    <p class="small">Si tu r√©v√®les ce secret, √ßa va te soulever b√™tement igo.</p>
    <div class="row">
      <button class="yes" id="replay">Revivre cette exp√©rience unique</button>
      ${isAdmin() ? `<button class="no" id="reshuffle" style="position:static;">Refaire le tirage (dangereux)</button>` : ""}
    </div>
  `);
  document.getElementById("replay").onclick = () => {
  state.noCount = 0;
  // keep the SAME assignment
  screen1();
  };
  if (isAdmin()) {
  document.getElementById("reshuffle").onclick = () => {
    resetAssignment();
    screen1();
  };
}
}
/* ================= BOOT ================= */

screen1();
</script>
</body>
</html>
